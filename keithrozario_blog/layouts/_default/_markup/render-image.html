{{- $u := urls.Parse .Destination -}}
{{- $src := $u.String -}}
{{- if not $u.IsAbs -}}
  {{- $path := strings.TrimPrefix "/" $src -}}
  {{- with resources.Get $path -}}
    {{- $img := . -}}
    {{- if eq $img.MediaType.SubType "svg" -}}
      <img src="{{ $img.RelPermalink }}" alt="{{ $.Text }}" {{ with $.Title }} title="{{ . }}"{{ end }} />
    {{- else -}}
      {{- $small := $img.Resize "480x" -}}
      {{- $medium := $img.Resize "768x" -}}
      {{- $large := $img.Resize "1024x" -}}
      {{- if gt $img.Width 1024 -}}
        <img
          src="{{ $medium.RelPermalink }}"
          srcset="
            {{ $small.RelPermalink }} 480w,
            {{ $medium.RelPermalink }} 768w,
            {{ $large.RelPermalink }} 1024w,
            {{ $img.RelPermalink }} {{ $img.Width }}w"
          sizes="(max-width: 480px) 480px, (max-width: 768px) 768px, (max-width: 1024px) 1024px, 100vw"
          alt="{{ $.Text }}"
          {{ with $.Title }} title="{{ . }}"{{ end }}
          loading="lazy"
        />
      {{- else -}}
        <img
          src="{{ $img.RelPermalink }}"
          alt="{{ $.Text }}"
          {{ with $.Title }} title="{{ . }}"{{ end }}
          loading="lazy"
        />
      {{- end -}}
    {{- end -}}
  {{- else -}}
    <img src="{{ .Destination | safeURL }}" alt="{{ .Text }}" {{ with .Title}} title="{{ . }}"{{ end }} />
  {{- end -}}
{{- else -}}
  <img src="{{ .Destination | safeURL }}" alt="{{ .Text }}" {{ with .Title}} title="{{ . }}"{{ end }} />
{{- end -}}
